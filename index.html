<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TMA Ultimate Test Site v8.0+</title>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #222222);
            --btn-color: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #a8a8a8);
            --section-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 16px;
            margin: 0;
            padding-bottom: 100px; /* Space for main buttons */
        }

        h2, h3 { margin-top: 0; }
        
        .card {
            background: var(--section-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        button {
            display: block;
            width: 100%;
            padding: 14px;
            margin-bottom: 8px;
            border: none;
            border-radius: 10px;
            background-color: var(--btn-color);
            color: var(--btn-text);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:active { opacity: 0.8; }
        
        button.secondary {
            background-color: transparent;
            color: var(--btn-color);
            border: 2px solid var(--btn-color);
        }

        .status {
            font-family: monospace;
            font-size: 12px;
            color: var(--hint-color);
            word-break: break-all;
        }
        
        .row { display: flex; gap: 10px; }
        .row button { flex: 1; }
    </style>
</head>
<body>

    <div class="card">
        <h3>System Info</h3>
        <div id="debug" class="status">Loading...</div>
        <div class="row" style="margin-top:10px;">
            <button class="secondary" onclick="tg.expand()">Expand</button>
            <button class="secondary" onclick="tg.close()">Close</button>
        </div>
    </div>

    <div class="card">
        <h3>1. Main & Secondary Buttons</h3>
        <p class="status">Secondary Button requires v7.10+</p>
        <button onclick="toggleMainButton()">Toggle Main Button</button>
        <button onclick="toggleSecondaryButton()">Toggle Secondary Button</button>
        <button onclick="moveSecondaryButton()">Change Sec. Button Pos</button>
        <button onclick="setSettingsButton()">Show Settings Button</button>
    </div>

    <div class="card">
        <h3>2. Cloud Storage (Key-Value)</h3>
        <input type="text" id="cloudInput" placeholder="Enter value..." style="width:100%; padding:10px; box-sizing:border-box; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
        <div class="row">
            <button onclick="saveCloud()">Save 'test_key'</button>
            <button onclick="loadCloud()">Load 'test_key'</button>
        </div>
        <div class="row">
             <button class="secondary" onclick="removeCloud()">Delete Key</button>
             <button class="secondary" onclick="getKeys()">List Keys</button>
        </div>
        <div id="cloudStatus" class="status"></div>
    </div>

    <div class="card">
        <h3>3. Biometrics Manager</h3>
        <div id="bioStatus" class="status">Not initialized</div>
        <button onclick="initBiometrics()">Init & Request Access</button>
        <button onclick="authBiometrics()">Authenticate User</button>
    </div>

    <div class="card">
        <h3>4. Utilities & Haptics</h3>
        <div class="row">
            <button onclick="tg.HapticFeedback.notificationOccurred('success')">Success</button>
            <button onclick="tg.HapticFeedback.notificationOccurred('error')">Error</button>
        </div>
        <div class="row">
            <button onclick="tg.HapticFeedback.impactOccurred('medium')">Impact</button>
            <button onclick="tg.HapticFeedback.selectionChanged()">Selection</button>
        </div>
        <button onclick="scanQR()">Scan QR Code</button>
        <button onclick="requestWriteAccess()">Request Write Access</button>
        <button onclick="addToHome()">Add to Home Screen (v8.0)</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const debugEl = document.getElementById('debug');
        
        // --- INITIALIZATION ---
        tg.ready();
        tg.enableClosingConfirmation(); // Prevent swipe-to-close
        
        // Update debug info
        function updateDebug() {
            debugEl.innerHTML = `
                Ver: ${tg.version}<br>
                Platform: ${tg.platform}<br>
                Theme: ${tg.colorScheme}<br>
                Expanded: ${tg.isExpanded}
            `;
        }
        updateDebug();
        setInterval(updateDebug, 2000);

        // --- 1. BUTTONS LOGIC ---
        let mainBtnState = false;
        function toggleMainButton() {
            if (mainBtnState) {
                tg.MainButton.hide();
            } else {
                tg.MainButton.setText("PROCESS ORDER").show().onClick(() => {
                    tg.showAlert("Main Button Clicked!");
                });
            }
            mainBtnState = !mainBtnState;
        }

        let secBtnState = false;
        function toggleSecondaryButton() {
            if (!tg.isVersionAtLeast('7.10')) return alert('Secondary Button requires v7.10');
            
            if (secBtnState) {
                tg.SecondaryButton.hide();
            } else {
                tg.SecondaryButton.setText("CANCEL").show().onClick(() => {
                    tg.showAlert("Secondary Button Clicked!");
                });
            }
            secBtnState = !secBtnState;
        }

        let secBtnPos = 'bottom';
        function moveSecondaryButton() {
            if (!tg.isVersionAtLeast('7.10')) return alert('Requires v7.10');
            
            // Toggle position
            secBtnPos = (secBtnPos === 'bottom') ? 'top' : (secBtnPos === 'top' ? 'left' : 'bottom');
            tg.SecondaryButton.setParams({ position: secBtnPos });
            tg.showAlert(`Position set to: ${secBtnPos}`);
        }
        
        function setSettingsButton() {
             tg.SettingsButton.show().onClick(() => {
                 tg.showAlert("Settings opened!");
             });
        }

        // --- 2. CLOUD STORAGE LOGIC ---
        function saveCloud() {
            const val = document.getElementById('cloudInput').value;
            tg.CloudStorage.setItem('test_key', val, (err, stored) => {
                if(err) return alert("Error: "+err);
                document.getElementById('cloudStatus').innerText = "Saved: " + (stored ? 'YES' : 'NO');
            });
        }
        
        function loadCloud() {
            tg.CloudStorage.getItem('test_key', (err, val) => {
                if(err) return alert("Error: "+err);
                document.getElementById('cloudStatus').innerText = "Loaded Value: " + val;
                if(val) document.getElementById('cloudInput').value = val;
            });
        }
        
        function removeCloud() {
            tg.CloudStorage.removeItem('test_key', (err, deleted) => {
                 document.getElementById('cloudStatus').innerText = "Deleted: " + (deleted ? 'YES' : 'NO');
                 document.getElementById('cloudInput').value = "";
            });
        }

        function getKeys() {
            tg.CloudStorage.getKeys((err, keys) => {
                if(err) return alert(err);
                alert("Keys: " + JSON.stringify(keys));
            });
        }

        // --- 3. BIOMETRICS LOGIC ---
        function initBiometrics() {
            if (!tg.BiometricManager) return alert("Biometrics not supported on this device/version");
            
            tg.BiometricManager.init(() => {
                const bio = tg.BiometricManager;
                document.getElementById('bioStatus').innerHTML = `
                    Available: ${bio.isBiometricAvailable}<br>
                    Access Granted: ${bio.isAccessGranted}<br>
                    Type: ${bio.biometricType}
                `;
                
                if(!bio.isAccessGranted) {
                    bio.requestAccess({reason: "Authenticate for Demo"}, (granted) => {
                        if(granted) alert("Access Granted!");
                    });
                }
            });
        }

        function authBiometrics() {
            const bio = tg.BiometricManager;
            if(!bio.isInited) return alert("Init first!");
            
            bio.authenticate({reason: "Verify Identity"}, (success, token) => {
                if(success) tg.showAlert("Authenticated successfully!");
                else tg.showAlert("Authentication failed.");
            });
        }

        // --- 4. UTILITIES ---
        function scanQR() {
            tg.showScanQrPopup({text: "Scan a QR Code"}, (content) => {
                tg.closeScanQrPopup();
                tg.showAlert("Scanned: " + content);
                return true;
            });
        }

        function requestWriteAccess() {
             tg.requestWriteAccess((allowed) => {
                 tg.showAlert("Write permission: " + allowed);
             });
        }

        function addToHome() {
            if(tg.isVersionAtLeast('8.0')) {
                tg.addToHomeScreen();
            } else {
                alert("Requires v8.0");
            }
        }
    </script>
</body>
</html>
