<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TMA Ultimate Test Site 2026</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            padding: 20px;
            margin: 0;
        }
        button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: bold;
            cursor: pointer;
        }
        .section {
            border-top: 1px solid #ccc;
            margin-top: 20px;
            padding-top: 10px;
        }
        pre {
            background: #eee;
            padding: 10px;
            font-size: 11px;
            overflow-x: auto;
            color: #333;
        }
    </style>
</head>
<body>

    <h2>TMA Features (v8.0+)</h2>
    
    <div class="section">
        <h3>System UI</h3>
        <button onclick="tg.expand()">Expand App</button>
        <button onclick="toggleMainButton()">Toggle MainButton</button>
        <button onclick="toggleBackButton()">Toggle BackButton</button>
        <button onclick="openPopup()">Test showPopup</button>
    </div>

    <div class="section">
        <h3>New 2025/2026 Features</h3>
        <button onclick="shareStory()">Share to Story (v7.8+)</button>
        <button onclick="addToHomeScreen()">Add to Home Screen (v8.0+)</button>
        <button onclick="requestLocation()">Request Precise Location</button>
        <button onclick="testBiometrics()">Biometrics (FaceID/Fingerprint)</button>
    </div>

    <div class="section">
        <h3>Utilities</h3>
        <button onclick="tg.showScanQrPopup({text: 'Scan anything'})">Scan QR Code</button>
        <button onclick="copyWebAppObject()">Copy WebApp Object JSON</button>
        <button onclick="tg.HapticFeedback.notificationOccurred('success')">Test Haptic (Success)</button>
        <button onclick="sendDataToBot()">Send Data to Bot</button>
    </div>

    <div class="section">
        <h3>Debug Info</h3>
        <pre id="debug">API Version: <span id="ver"></span></pre>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        document.getElementById('ver').innerText = tg.version;

        // Initialize App
        tg.ready();
        tg.enableClosingConfirmation();

        // 1. Share to Stories (Properly via WebApp API)
        function shareStory() {
            if (tg.isVersionAtLeast('7.8')) {
                tg.shareToStory("https://picsum.photos/1080/1920", {
                    text: "Testing new Mini App capabilities!",
                    widget_link: {
                        url: "https://t.me/ChessioBot",
                        name: "Try Mini App"
                    }
                });
            } else {
                alert("Story sharing requires v7.8+");
            }
        }

        // 2. Add to Home Screen (v8.0+)
        function addToHomeScreen() {
            if (tg.isVersionAtLeast('8.0')) {
                tg.addToHomeScreen();
            } else {
                alert("Home screen shortcuts require v8.0+");
            }
        }

        // 3. Location Services
        function requestLocation() {
            tg.LocationManager.init(() => {
                tg.LocationManager.getLocation((data) => {
                    alert(`Lat: ${data.latitude}, Lon: ${data.longitude}`);
                });
            });
        }

        // 4. Biometrics
        function testBiometrics() {
            tg.BiometricManager.init(() => {
                if (!tg.BiometricManager.isInited) return;
                tg.BiometricManager.authenticate({reason: "Testing Biometrics"}, (success) => {
                    alert(success ? "Authenticated!" : "Failed/Cancelled");
                });
            });
        }

        // --- Standard UI Logic ---
        function toggleMainButton() {
            if (tg.MainButton.isVisible) {
                tg.MainButton.hide();
            } else {
                tg.MainButton.setText("MAIN ACTION");
                tg.MainButton.show();
            }
        }

        function toggleBackButton() {
            tg.BackButton.isVisible ? tg.BackButton.hide() : tg.BackButton.show();
        }

        function openPopup() {
            tg.showPopup({
                title: 'Test Popup',
                message: 'ServiceNow Integration Test?',
                buttons: [
                    {id: 'btn_yes', type: 'ok', text: 'Yes'},
                    {id: 'btn_no', type: 'destructive', text: 'Cancel'}
                ]
            }, (id) => {
                console.log("Button clicked:", id);
            });
        }

        function copyWebAppObject() {
            const data = JSON.stringify(tg, null, 2);
            navigator.clipboard.writeText(data);
            tg.showAlert("Object Copied to Clipboard!");
        }

        function sendDataToBot() {
            tg.sendData("ServiceNow_Event_001");
        }

        // Listen for events
        tg.onEvent('backButtonClicked', () => {
            tg.showAlert("Back button pressed!");
            tg.BackButton.hide();
        });
    </script>
</body>
</html>
